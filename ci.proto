syntax = "proto3";

package ci;

option go_package = "ci/proto";

// Worker conecta na matriz e abre stream bidirecional
service Matriz {
  rpc Connect(stream WorkerMessage) returns (stream MatrizMessage);
}

// Mensagens do worker para matriz
message WorkerMessage {
  uint64 id = 1; // referencia comando da matriz (0 = sem comando associado)
  
  oneof payload {
    RunnerInfo runner_info = 2;    // enviado uma vez no connect
    Output output = 3;             // stdout/stderr de comando em andamento
    Done done = 4;                 // comando finalizado
    FileChunk file_chunk = 5;      // chunk de arquivo sendo enviado
    Error error = 6;               // erro no comando
  }
}

// Mensagens da matriz para worker
message MatrizMessage {
  uint64 id = 1; // id sequencial do comando
  
  oneof payload {
    Copy copy = 2;
    Run run = 3;
    Close close = 4;
  }
}

// Info do runner, enviado no connect
message RunnerInfo {
  string hostname = 1;
  string os = 2;
  string arch = 3;
  map<string, string> extra = 4;
}

// Copia arquivos - bidirecional
message Copy {
  Direction direction = 1;
  string source = 2;       // URL (git, http) ou path local
  string dest = 3;         // path destino
  Credentials creds = 4;   // opcional
  
  enum Direction {
    TO_WORKER = 0;    // matriz/remote -> worker
    FROM_WORKER = 1;  // worker -> matriz
  }
}

message Credentials {
  oneof auth {
    string token = 1;
    BasicAuth basic = 2;
  }
}

message BasicAuth {
  string username = 1;
  string password = 2;
}

// Executa comando
message Run {
  string cmd = 1;
  repeated string args = 2;
  map<string, string> env = 3;
  string workdir = 4;
}

// Stream de output
message Output {
  Stream stream = 1;
  bytes data = 2;
  
  enum Stream {
    STDOUT = 0;
    STDERR = 1;
  }
}

// Comando finalizado
message Done {
  int32 exit_code = 1;
}

// Chunk de arquivo (pra transferências grandes)
message FileChunk {
  bytes data = 1;
  bool eof = 2;
}

// Erro
message Error {
  string message = 1;
}

// Fecha conexão
message Close {}

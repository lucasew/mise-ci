{{template "layout" .}}

{{define "content"}}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Issues for {{.Repo}}</h1>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="copyContext()">
                Copy Context
            </button>
            <a href="/ui/" class="btn btn-outline-secondary">Back to Runs</a>
        </div>
    </div>

    {{if .Issues}}
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Severity</th>
                <th>Tool</th>
                <th>Rule ID</th>
                <th>Message</th>
                <th>Location</th>
                <th>Commit</th>
            </tr>
        </thead>
        <tbody>
            {{range .Issues}}
            <tr>
                <td>
                    <span class="badge {{if eq .Severity "error"}}bg-danger{{else if eq .Severity "warning"}}bg-warning text-dark{{else}}bg-info text-dark{{end}}">
                        {{.Severity}}
                    </span>
                </td>
                <td>{{.Tool}}</td>
                <td><code>{{.RuleID}}</code></td>
                <td>{{.Message}}</td>
                <td>{{.Path}}:{{.Line}}</td>
                <td>
                    <a href="/ui/run/{{.RunID}}">
                        {{if .CommitMessage}}{{.CommitMessage | subject}}{{else}}{{.RunID}}{{end}}
                    </a>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p class="text-muted">No issues found.</p>
    {{end}}
</div>

<script>
function copyContext() {
    const issues = [];
    document.querySelectorAll('tbody tr').forEach(row => {
        const cols = row.querySelectorAll('td');
        // Extract data (robustness check: ensure row has expected columns)
        if (cols.length >= 5) {
            issues.push({
                severity: cols[0].innerText.trim(),
                tool: cols[1].innerText.trim(),
                rule: cols[2].innerText.trim(),
                message: cols[3].innerText.trim(),
                location: cols[4].innerText.trim()
            });
        }
    });

    // Build XML using DOM to ensure correct escaping
    const doc = document.implementation.createDocument(null, 'context', null);
    const issuesElem = doc.createElement('issues');
    doc.documentElement.appendChild(issuesElem);

    issues.forEach(i => {
        const issueElem = doc.createElement('issue');
        issueElem.setAttribute('tool', i.tool);
        issueElem.setAttribute('rule', i.rule);
        issueElem.setAttribute('location', i.location);
        issueElem.setAttribute('severity', i.severity);
        issueElem.textContent = i.message;
        issuesElem.appendChild(issueElem);
    });

    const serializer = new XMLSerializer();
    const xmlStr = serializer.serializeToString(doc);

    navigator.clipboard.writeText(xmlStr).then(() => {
        alert('Context copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy context.');
    });
}
</script>
{{end}}
